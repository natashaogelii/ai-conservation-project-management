{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Home - {{ user.username }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f5f5f5; }
    .navbar { background-color: #06402B; color:#f5f5f5}
    .sidebar { height: 100vh; position: fixed; width: 70px; background-color: #06402B; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
    .sidebar a { color: #fff; margin: 20px 0; font-size: 1.5rem; text-decoration: none; }
    .main-content { margin-left: 100px; padding: 20px; }
    .project-card { background-color: #fff; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .project-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .project-title { font-size: 1.5rem; font-weight: bold; }
    .project-dates, .project-budget, .pending-tasks { margin-top: 10px; }
    .task { background-color: #e9ecef; padding: 5px 10px; border-radius: 5px; margin-bottom: 5px; }
    .search-bar { margin-bottom: 20px; }
  </style>
</head>
<body>
   <!-- Navbar/Header -->
  <div class="navbar">
    <h5>Project Management</h5>
    <div class="user-name">{{ user.username }}</div>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <a href="{% url 'project_create' %}" title="Add Project">âž•</a>
    <a href="{% url 'project_list' %}" title="Projects">ðŸ“…</a>
    {% if projects %}
      <a href="{% url 'add_expenditure' %}" title="Add Expenditure">ðŸ“Š</a>
    {% else %}
      <a href="#" title="Add Expenditure" style="opacity: 0.5; pointer-events: none;">ðŸ“Š</a>
    {% endif %}
    
  </div>

  <!-- Main Content -->
  <div class="main-content container-fluid">
    <h2>Welcome, {{ user.username }}!</h2>


    <!-- Search -->
    <form method="get" class="search-bar">
      <div class="input-group">
        <input type="text" name="q" class="form-control" placeholder="Search projects..." value="{{ request.GET.q }}">
        <button class="btn btn-primary" type="submit">Search</button>
      </div>
    </form>

<!-- Projects -->
{% for project in projects %}
  <div class="project-card">
    <div class="project-header">
      <div class="project-title">{{ project.title }}</div>
      <div class="project-actions flex gap-2 mt-2">
    <!-- Edit Button -->
    <a href="{% url 'project_edit' project.id %}" 
       class="px-3 py-1 bg-green-400 text-white rounded hover:bg-green-500 text-sm">
       Edit
    </a>

    <!-- Delete Button -->
    <a href="{% url 'project_delete_confirm' project.id %}" 
       class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 text-sm">
       Delete
    </a>
</div>
    </div>

    <div class="project-dates">
      <strong>Start:</strong> {{ project.start_date }} | <strong>End:</strong> {{ project.end_date }}
    </div>
    <div class="project-budget">
      <strong>Budget:</strong> ${{ project.budget }} | 
      <strong>Remaining:</strong> ${{ project.remaining_budget }}
    </div>

    <!-- Pending tasks -->
    {% for item in pending_tasks %}
      {% if item.project.id == project.id %}
        <div class="pending-tasks mt-2">
          <h5>Pending Tasks:</h5>
          <div class="task">
            <strong>{{ item.task.title }}</strong> - Due: {{ item.task.due_date }}
          </div>
        </div>
      {% endif %}
    {% endfor %}

    <!-- Expenditures -->
    <div class="project-expenditures mt-3">
      <h5>Expenditures:</h5>
      {% if project.expenses.all %}
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Description</th>
              <th>Amount</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            {% for expense in project.expenses.all %}
              <tr>
                <td>{{ expense.description }}</td>
                <td>${{ expense.amount }}</td>
                <td>{{ expense.date }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="3">No expenditures yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <em>No expenditures yet.</em>
      {% endif %}
    </div>
  </div>
{% empty %}
  <p>No projects found.</p>
{% endfor %}


<button id="chatbot-toggle" style="position:fixed; bottom:20px; right:20px; background:#2c7be5; color:white; border:none; border-radius:50%; width:60px; height:60px;">ðŸ’¬</button>

<div id="chatbot-container" style="display:none; position:fixed; bottom:90px; right:20px; width:300px; height:400px; background:white; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.2); overflow:hidden;">
  <div id="chatbot-messages" style="height:340px; overflow-y:auto; padding:10px;"></div>
  <input id="chatbot-input" type="text" placeholder="Ask about a project..." style="width:100%; border:none; border-top:1px solid #ccc; padding:10px;">
</div>

<script>
const toggle = document.getElementById("chatbot-toggle");
const container = document.getElementById("chatbot-container");
const input = document.getElementById("chatbot-input");
const messages = document.getElementById("chatbot-messages");

toggle.addEventListener("click", () => {
  container.style.display = container.style.display === "none" ? "block" : "none";
});

input.addEventListener("keypress", e => {
  if (e.key === "Enter") {
    const msg = input.value;
    messages.innerHTML += `<div><b>You:</b> ${msg}</div>`;
    fetch("/chatbot/chat/", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({message: msg})
    })
    .then(res => res.json())
    .then(data => {
      messages.innerHTML += `<div><b>Bot:</b> ${data.response}</div>`;
      messages.scrollTop = messages.scrollHeight;
    });
    input.value = "";
  }
});
</script>
